<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Garage Preview</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #222;
        }

        canvas {
            display: block;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 0;
        }

        #center-square-black {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 480px;
            height: 480px;
            border: 11px solid black;
            background: transparent;
            pointer-events: none;
            box-sizing: border-box;
            z-index: 1;
        }

        #center-square {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 460px;
            height: 460px;
            border: 30px solid white;
            background: transparent;
            pointer-events: none;
            box-sizing: border-box;
            z-index: 2;
        }

        #arrow-image-right {
            position: absolute;
            top: 70%;
            right: 0%;
            width: calc(10vw);
            transform: translate(100%, -50%);
            pointer-events: auto;
            cursor: pointer;
            transition: width 0.15s ease, transform 0.15s ease;
        }

        #arrow-image-right:active,
        .arrow-shrink-right {
            width: calc(8vw) !important;
            transform: translate(100%, -50%) matrix3d(1, 0, 0, 0.003,
                    0, 1, 0, 0,
                    0, 0, 1, 0,
                    0, 0, 0, 1) !important;
        }

        #arrow-image-left {
            position: absolute;
            top: 70%;
            left: 0%;
            width: calc(10vw);
            transform: translate(-100%, -50%) scaleX(-1);
            pointer-events: auto;
            cursor: pointer;
            transition: width 0.15s ease, transform 0.15s ease, left 0.15s ease;
        }

        #arrow-image-left:active,
        .arrow-shrink-left {
            width: calc(8vw) !important;
            transform: translate(-100%, -50%) scaleX(-1) matrix3d(1, 0, 0, 0.003,
                    0, 1, 0, 0,
                    0, 0, 1, 0,
                    0, 0, 0, 1) !important;
        }

        #arrow-image-down {
            position: absolute;
            bottom: 0%;
            left: 50%;
            width: calc(10vw);
            transform: translate(-50%, 100%) rotate(90deg);
            pointer-events: auto;
            cursor: pointer;
            transition: width 0.15s ease, transform 0.15s ease;
        }

        #arrow-image-down:active,
        .arrow-shrink-down {
            width: calc(8vw) !important;
            transform: translate(-50%, 100%) rotate(90deg) matrix3d(1, 0, 0, 0.003,
                    0, 1, 0, 0,
                    0, 0, 1, 0,
                    0, 0, 0, 1) !important;
        }

        /* Collapsable Panel Styles */
        .panel-section {
            margin-top: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            overflow: hidden;
        }

        .panel-header {
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 12px;
            cursor: pointer;
            user-select: none;
            font-size: 14px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
        }

        .panel-header:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .panel-header::after {
            content: 'â–¼';
            font-size: 10px;
            transition: transform 0.2s;
        }

        .panel-header.collapsed::after {
            transform: rotate(-90deg);
        }

        .panel-content {
            padding: 10px;
            max-height: 2000px;
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease, opacity 0.3s ease;
            opacity: 1;
        }

        .panel-content.collapsed {
            max-height: 0 !important;
            padding: 0 10px !important;
            opacity: 0;
            overflow: hidden;
        }

        .control-row {
            margin-top: 10px;
        }

        .control-row:first-child {
            margin-top: 0;
        }
    </style>
</head>

<body>

    <div id="center-square-black">
        <img id="arrow-image-right" src="Arrow.webp" alt="Arrow">
        <img id="arrow-image-left" src="Arrow.webp" alt="Arrow">
        <img id="arrow-image-down" src="Arrow.webp" alt="Arrow Down">

    </div>
    <div id="center-square">
    </div>

    <div id="ui-container"
        style="position: absolute; top: 20px; left: 20px; color: white; background: rgba(0,0,0,0.8); padding: 0; border-radius: 8px; font-family: sans-serif; pointer-events: auto; user-select: none; max-width: 280px; z-index: 1001;">

        <!-- Main Panel Header -->
        <div class="panel-header" onclick="toggleSection(this)" style="border-radius: 8px 8px 0 0; margin: 0;">
            ðŸ”§ Garage Controls
        </div>

        <div class="panel-content" style="max-height: 80vh; overflow-y: auto; padding: 15px;">

            <!-- Grid Section -->
            <div class="panel-section" style="pointer-events: auto;">
                <div class="panel-header" onclick="toggleSection(this)">Grid Settings</div>
                <div class="panel-content">
                    <div class="control-row">
                        <label style="font-size: 14px; font-weight: bold; display: block; margin-bottom: 5px;">Grid
                            Spacing:
                            <span id="spacing-val" style="color: #00ff88;">1.20</span></label>
                        <input type="range" id="spacing-slider" min="0.5" max="2.0" step="0.01" value="1.20"
                            style="width: 200px; cursor: pointer;">
                    </div>
                </div>
            </div>

            <!-- Camera Section -->
            <div class="panel-section" style="pointer-events: auto;">
                <div class="panel-header" onclick="toggleSection(this)">Camera Settings</div>
                <div class="panel-content">
                    <div class="control-row">
                        <label style="font-size: 14px; font-weight: bold; display: block; margin-bottom: 5px;">Cam
                            Distance:
                            <span id="distance-val" style="color: #00ff88;">2.0</span></label>
                        <input type="range" id="distance-slider" min="0.1" max="10.0" step="0.1" value="2.0"
                            style="width: 200px; cursor: pointer;">
                    </div>
                    <div class="control-row">
                        <label
                            style="font-size: 14px; font-weight: bold; display: block; margin-bottom: 5px;">Transition
                            Speed:
                            <span id="speed-val" style="color: #00ff88;">0.50</span></label>
                        <input type="range" id="speed-slider" min="0.01" max="0.5" step="0.01" value="0.50"
                            style="width: 200px; cursor: pointer;">
                    </div>
                    <div class="control-row">
                        <label style="font-size: 14px; font-weight: bold; display: block; margin-bottom: 5px;">UI/Render
                            Ratio:
                            <span id="ratio-val" style="color: #00ff88;">185</span></label>
                        <input type="range" id="ratio-slider" min="180" max="195" step="1" value="185"
                            style="width: 200px; cursor: pointer;">
                    </div>
                </div>
            </div>

            <!-- Shake Section -->
            <div class="panel-section" style="pointer-events: auto;">
                <div class="panel-header" onclick="toggleSection(this)">Shake Effects</div>
                <div class="panel-content">
                    <div class="control-row">
                        <label style="font-size: 14px; font-weight: bold; display: block; margin-bottom: 5px;">Shake
                            Force
                            (Mag):
                            <span id="shake-val" style="color: #00ff88;">0.00</span></label>
                        <input type="range" id="shake-slider" min="0.0" max="0.5" step="0.01" value="0.0"
                            style="width: 200px; cursor: pointer;">
                    </div>
                    <div class="control-row" style="display: flex; gap: 10px;">
                        <div>
                            <label style="font-size: 12px; display: block; margin-bottom: 2px;">Length (Decay)</label>
                            <input type="range" id="shake-len-slider" min="0.80" max="0.99" step="0.01" value="0.80"
                                style="width: 95px;">
                        </div>
                        <div>
                            <label style="font-size: 12px; display: block; margin-bottom: 2px;">Speed (Freq)</label>
                            <input type="range" id="shake-spd-slider" min="5" max="50" step="1" value="25"
                                style="width: 95px;">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Squares Section -->
            <div class="panel-section" style="pointer-events: auto;">
                <div class="panel-header" onclick="toggleSection(this)">Center Squares</div>
                <div class="panel-content">
                    <div class="control-row">
                        <label style="font-size: 14px; font-weight: bold; display: block; margin-bottom: 5px;">White
                            Square</label>
                        <div style="display: flex; gap: 10px; margin-top: 5px;">
                            <div>
                                <label style="font-size: 12px; display: block; margin-bottom: 2px;">Size: <span
                                        id="white-size-val" style="color: #00ff88;">440</span>px</label>
                                <input type="range" id="white-size-slider" min="50" max="500" step="10" value="440"
                                    style="width: 95px;">
                            </div>
                            <div>
                                <label style="font-size: 12px; display: block; margin-bottom: 2px;">Border: <span
                                        id="white-border-val" style="color: #00ff88;">30</span>px</label>
                                <input type="range" id="white-border-slider" min="1" max="50" step="1" value="30"
                                    style="width: 95px;">
                            </div>
                        </div>
                    </div>
                    <div class="control-row">
                        <label style="font-size: 14px; font-weight: bold; display: block; margin-bottom: 5px;">Black
                            Square</label>
                        <div style="display: flex; gap: 10px; margin-top: 5px;">
                            <div>
                                <label style="font-size: 12px; display: block; margin-bottom: 2px;">Size: <span
                                        id="black-size-val" style="color: #00ff88;">460</span>px</label>
                                <input type="range" id="black-size-slider" min="50" max="500" step="10" value="460"
                                    style="width: 95px;">
                            </div>
                            <div>
                                <label style="font-size: 12px; display: block; margin-bottom: 2px;">Border: <span
                                        id="black-border-val" style="color: #00ff88;">11</span>px</label>
                                <input type="range" id="black-border-slider" min="1" max="50" step="1" value="11"
                                    style="width: 95px;">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Car Section -->
            <div class="panel-section" style="pointer-events: auto;">
                <div class="panel-header" onclick="toggleSection(this)">Car Settings</div>
                <div class="panel-content">
                    <div class="control-row">
                        <label
                            style="font-size: 14px; font-weight: bold; display: block; margin-bottom: 5px;">Position</label>
                        <div style="display: flex; gap: 10px; margin-top: 5px;">
                            <div>
                                <label style="font-size: 12px; display: block; margin-bottom: 2px;">X: <span
                                        id="car-pos-x-val" style="color: #00ff88;">0.03</span></label>
                                <input type="range" id="car-pos-x-slider" min="-2" max="2" step="0.01" value="0.03"
                                    style="width: 65px;">
                            </div>
                            <div>
                                <label style="font-size: 12px; display: block; margin-bottom: 2px;">Y: <span
                                        id="car-pos-y-val" style="color: #00ff88;">-0.50</span></label>
                                <input type="range" id="car-pos-y-slider" min="-2" max="2" step="0.01" value="-0.50"
                                    style="width: 65px;">
                            </div>
                            <div>
                                <label style="font-size: 12px; display: block; margin-bottom: 2px;">Z: <span
                                        id="car-pos-z-val" style="color: #00ff88;">-0.04</span></label>
                                <input type="range" id="car-pos-z-slider" min="-2" max="2" step="0.01" value="-0.04"
                                    style="width: 65px;">
                            </div>
                        </div>
                    </div>
                    <div class="control-row">
                        <label
                            style="font-size: 14px; font-weight: bold; display: block; margin-bottom: 5px;">Rotation</label>
                        <div style="display: flex; gap: 10px; margin-top: 5px;">
                            <div>
                                <label style="font-size: 12px; display: block; margin-bottom: 2px;">X: <span
                                        id="car-rot-x-val" style="color: #00ff88;">0</span>Â°</label>
                                <input type="range" id="car-rot-x-slider" min="-180" max="180" step="1" value="0"
                                    style="width: 65px;">
                            </div>
                            <div>
                                <label style="font-size: 12px; display: block; margin-bottom: 2px;">Y: <span
                                        id="car-rot-y-val" style="color: #00ff88;">-118</span>Â°</label>
                                <input type="range" id="car-rot-y-slider" min="-180" max="180" step="1" value="-118"
                                    style="width: 65px;">
                            </div>
                            <div>
                                <label style="font-size: 12px; display: block; margin-bottom: 2px;">Z: <span
                                        id="car-rot-z-val" style="color: #00ff88;">0</span>Â°</label>
                                <input type="range" id="car-rot-z-slider" min="-180" max="180" step="1" value="0"
                                    style="width: 65px;">
                            </div>
                        </div>
                    </div>
                    <div class="control-row">
                        <label style="font-size: 14px; font-weight: bold; display: block; margin-bottom: 5px;">Scale:
                            <span id="car-scale-val" style="color: #00ff88;">0.30</span></label>
                        <input type="range" id="car-scale-slider" min="0.1" max="3" step="0.01" value="0.30"
                            style="width: 200px; cursor: pointer;">
                    </div>
                </div>
            </div>

            <!-- Light Section -->
            <div class="panel-section" style="pointer-events: auto;">
                <div class="panel-header" onclick="toggleSection(this)">Light Settings</div>
                <div class="panel-content">
                    <div class="control-row">
                        <label style="font-size: 14px; font-weight: bold; display: block; margin-bottom: 5px;">Dir Light
                            Position</label>
                        <div style="display: flex; gap: 10px; margin-top: 5px;">
                            <div>
                                <label style="font-size: 12px; display: block; margin-bottom: 2px;">X: <span
                                        id="light-pos-x-val" style="color: #00ff88;">5</span></label>
                                <input type="range" id="light-pos-x-slider" min="-50" max="50" step="1" value="5"
                                    style="width: 65px;">
                            </div>
                            <div>
                                <label style="font-size: 12px; display: block; margin-bottom: 2px;">Y: <span
                                        id="light-pos-y-val" style="color: #00ff88;">10</span></label>
                                <input type="range" id="light-pos-y-slider" min="0" max="50" step="1" value="10"
                                    style="width: 65px;">
                            </div>
                            <div>
                                <label style="font-size: 12px; display: block; margin-bottom: 2px;">Z: <span
                                        id="light-pos-z-val" style="color: #00ff88;">7</span></label>
                                <input type="range" id="light-pos-z-slider" min="-50" max="50" step="1" value="7"
                                    style="width: 65px;">
                            </div>
                        </div>
                    </div>
                    <div class="control-row">
                        <label style="font-size: 14px; font-weight: bold; display: block; margin-bottom: 5px;">Dir Light
                            Intensity:
                            <span id="light-dir-intensity-val" style="color: #00ff88;">3.2</span></label>
                        <input type="range" id="light-dir-intensity-slider" min="0" max="15" step="0.1" value="3.2"
                            style="width: 200px; cursor: pointer;">
                    </div>
                    <div class="control-row">
                        <label style="font-size: 14px; font-weight: bold; display: block; margin-bottom: 5px;">Ambient
                            Intensity:
                            <span id="light-ambient-intensity-val" style="color: #00ff88;">1.3</span></label>
                        <input type="range" id="light-ambient-intensity-slider" min="0" max="5" step="0.1" value="1.3"
                            style="width: 200px; cursor: pointer;">
                    </div>
                    <div class="control-row">
                        <label style="font-size: 14px; font-weight: bold; display: block; margin-bottom: 5px;">Dir Light
                            Color</label>
                        <input type="color" id="light-dir-color" value="#ffffff"
                            style="width: 100%; height: 30px; cursor: pointer; border: none; border-radius: 4px;">
                    </div>
                </div>
            </div>

            <div style="margin-top: 15px; pointer-events: auto;">
                <button onclick="printConfig()"
                    style="width: 100%; padding: 10px; background: rgba(0, 255, 136, 0.2); border: 1px solid #00ff88; color: #00ff88; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 14px;">
                    Print Config to Alert Box
                </button>
            </div>

            <div style="margin-top: 15px; font-size: 12px; color: #aaa; pointer-events: none;">
                Use <b>W, A, S, D</b> to navigate.
            </div>
        </div> <!-- End of main panel-content -->
    </div> <!-- End of ui-container -->

    <script async src="https://ga.jspm.io/npm:es-module-shims@1.10.1/dist/es-module-shims.js"></script>
    <script type="importmap-shim">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
        }
    }
    </script>

    <!-- Global Functions -->
    <script>
        // Collapsable Panel Toggle Function (must be global for onclick)
        function toggleSection(header) {
            const content = header.nextElementSibling;
            header.classList.toggle('collapsed');
            content.classList.toggle('collapsed');
        }

        // Print Config Function
        function printConfig() {
            const config = {
                grid: {
                    spacing: parseFloat(document.getElementById('spacing-slider').value)
                },
                camera: {
                    distance: parseFloat(document.getElementById('distance-slider').value),
                    transitionSpeed: parseFloat(document.getElementById('speed-slider').value)
                },
                shake: {
                    force: parseFloat(document.getElementById('shake-slider').value),
                    decay: parseFloat(document.getElementById('shake-len-slider').value),
                    frequency: parseInt(document.getElementById('shake-spd-slider').value)
                },
                squares: {
                    white: {
                        size: parseInt(document.getElementById('white-size-slider').value),
                        border: parseInt(document.getElementById('white-border-slider').value)
                    },
                    black: {
                        size: parseInt(document.getElementById('black-size-slider').value),
                        border: parseInt(document.getElementById('black-border-slider').value)
                    }
                },
                car: {
                    position: {
                        x: parseFloat(document.getElementById('car-pos-x-slider').value),
                        y: parseFloat(document.getElementById('car-pos-y-slider').value),
                        z: parseFloat(document.getElementById('car-pos-z-slider').value)
                    },
                    rotation: {
                        x: parseInt(document.getElementById('car-rot-x-slider').value),
                        y: parseInt(document.getElementById('car-rot-y-slider').value),
                        z: parseInt(document.getElementById('car-rot-z-slider').value)
                    },
                    scale: parseFloat(document.getElementById('car-scale-slider').value)
                },
                light: {
                    directional: {
                        position: {
                            x: parseInt(document.getElementById('light-pos-x-slider').value),
                            y: parseInt(document.getElementById('light-pos-y-slider').value),
                            z: parseInt(document.getElementById('light-pos-z-slider').value)
                        },
                        intensity: parseFloat(document.getElementById('light-dir-intensity-slider').value),
                        color: document.getElementById('light-dir-color').value
                    },
                    ambient: {
                        intensity: parseFloat(document.getElementById('light-ambient-intensity-slider').value)
                    }
                }
            };

            const configStr = JSON.stringify(config, null, 2);
            alert('Current Configuration:\n\n' + configStr);
            console.log('Garage Configuration:', config);
        }
    </script>

    <script type="module-shim">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { DRACOLoader } from 'three/addons/loaders/DRACOLoader.js';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // Scene Setup
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x222222);

        // Camera Setup
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(5, 0, 0); // Position 5 units back
        
        // Renderer Setup
        const renderer = new THREE.WebGLRenderer({ antialias: false });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio*.5);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        document.body.appendChild(renderer.domElement);

        // Controls
        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true; // Smooth motion
        controls.dampingFactor = 0.05;
        controls.enablePan = false;
        controls.target.set(0, 0, 0);
        // controls.update() called in animation loop

        // Lighting
        const ambientLight = new THREE.AmbientLight(0xffffff, 1.3);
        scene.add(ambientLight);

        const directionLight = new THREE.DirectionalLight(0xffffff, 3.2);
        directionLight.position.set(5, 10, 7);
        directionLight.castShadow = true;
        directionLight.shadow.mapSize.width = 2048;
        directionLight.shadow.mapSize.height = 2048;
        directionLight.shadow.camera.near = 0.5;
        directionLight.shadow.camera.far = 50;
        directionLight.shadow.camera.left = -10;
        directionLight.shadow.camera.right = 10;
        directionLight.shadow.camera.top = 10;
        directionLight.shadow.camera.bottom = -10;
        scene.add(directionLight);

        // Grid & Navigation State
        const gridItems = [];
        const spacingSlider = document.getElementById('spacing-slider');
        const spacingLabel = document.getElementById('spacing-val');
        const distSlider = document.getElementById('distance-slider');
        const distLabel = document.getElementById('distance-val');
        const speedSlider = document.getElementById('speed-slider');
        const speedLabel = document.getElementById('speed-val');
        const ratioSlider = document.getElementById('ratio-slider');
        const ratioLabel = document.getElementById('ratio-val');
        const shakeSlider = document.getElementById('shake-slider');
        const shakeLabel = document.getElementById('shake-val');
        const shakeLenSlider = document.getElementById('shake-len-slider');
        const shakeSpdSlider = document.getElementById('shake-spd-slider');
        
        // White Square Controls
        const whiteSizeSlider = document.getElementById('white-size-slider');
        const whiteSizeLabel = document.getElementById('white-size-val');
        const whiteBorderSlider = document.getElementById('white-border-slider');
        const whiteBorderLabel = document.getElementById('white-border-val');
        const centerSquare = document.getElementById('center-square');
        
        // Black Square Controls
        const blackSizeSlider = document.getElementById('black-size-slider');
        const blackSizeLabel = document.getElementById('black-size-val');
        const blackBorderSlider = document.getElementById('black-border-slider');
        const blackBorderLabel = document.getElementById('black-border-val');
        const centerSquareBlack = document.getElementById('center-square-black');

        // Car Controls
        const carPosXSlider = document.getElementById('car-pos-x-slider');
        const carPosXLabel = document.getElementById('car-pos-x-val');
        const carPosYSlider = document.getElementById('car-pos-y-slider');
        const carPosYLabel = document.getElementById('car-pos-y-val');
        const carPosZSlider = document.getElementById('car-pos-z-slider');
        const carPosZLabel = document.getElementById('car-pos-z-val');
        const carRotXSlider = document.getElementById('car-rot-x-slider');
        const carRotXLabel = document.getElementById('car-rot-x-val');
        const carRotYSlider = document.getElementById('car-rot-y-slider');
        const carRotYLabel = document.getElementById('car-rot-y-val');
        const carRotZSlider = document.getElementById('car-rot-z-slider');
        const carRotZLabel = document.getElementById('car-rot-z-val');
        const carScaleSlider = document.getElementById('car-scale-slider');
        const carScaleLabel = document.getElementById('car-scale-val');

        // Light Controls
        const lightPosXSlider = document.getElementById('light-pos-x-slider');
        const lightPosXLabel = document.getElementById('light-pos-x-val');
        const lightPosYSlider = document.getElementById('light-pos-y-slider');
        const lightPosYLabel = document.getElementById('light-pos-y-val');
        const lightPosZSlider = document.getElementById('light-pos-z-slider');
        const lightPosZLabel = document.getElementById('light-pos-z-val');
        const lightDirIntensitySlider = document.getElementById('light-dir-intensity-slider');
        const lightDirIntensityLabel = document.getElementById('light-dir-intensity-val');
        const lightAmbientIntensitySlider = document.getElementById('light-ambient-intensity-slider');
        const lightAmbientIntensityLabel = document.getElementById('light-ambient-intensity-val');
        const lightDirColorInput = document.getElementById('light-dir-color');

        let currentGridY = 0; // Row (-1 to 1)
        let currentGridZ = 0; // Col (-1 to 1)
        
        let currentShake = 0; // Decay factor
        
        // Target vectors for smooth transition
        const targetLookAt = new THREE.Vector3(0, 0, 0);
        const targetCamPos = new THREE.Vector3(5, 0, 0);

        function updateTargets() {
            const spacing = parseFloat(spacingSlider.value);
            const dist = parseFloat(distSlider.value);
            
            // Calculate target position based on selected grid cell
            const targetY = currentGridY * spacing;
            const targetZ = currentGridZ * spacing;
            
            targetLookAt.set(0, targetY, targetZ);
            targetCamPos.set(dist, targetY, targetZ);

            // Update Target Colors for Highlighting
            const activeColor = new THREE.Color(0xffffff); // Bright
            const dimmedColor = new THREE.Color(0x333333); // Darkened

            gridItems.forEach(item => {
                const isSelected = (item.gridY === currentGridY && item.gridZ === currentGridZ);
                item.targetColor = isSelected ? activeColor : dimmedColor;
                
                // Toggle lock sprite visibility - only show when selected and locked
                if (item.car && item.car.userData.lockSprite) {
                    item.car.userData.lockSprite.visible = isSelected && item.isLocked;
                }
            });
            
            // Trigger Shake
            currentShake = parseFloat(shakeSlider.value);
        }

        function updateGridSpacing() {
            const spacing = parseFloat(spacingSlider.value);
            spacingLabel.textContent = spacing.toFixed(2);

            gridItems.forEach(item => {
                item.mesh.position.set(0, item.gridY * spacing, item.gridZ * spacing);
            });
            updateTargets();
        }

        function updateDistance() {
            const dist = parseFloat(distSlider.value);
            distLabel.textContent = dist.toFixed(1);
            updateTargets();
        }
        
        function updateSpeed() {
             speedLabel.textContent = parseFloat(speedSlider.value).toFixed(2);
        }
        
        function updateShakeVal() {
            shakeLabel.textContent = parseFloat(shakeSlider.value).toFixed(2);
        }
        
        function updateWhiteSize() {
            const size = parseInt(whiteSizeSlider.value);
            whiteSizeLabel.textContent = size;
            centerSquare.style.width = size + 'px';
            centerSquare.style.height = size + 'px';
        }
        
        function updateWhiteBorder() {
            const width = parseInt(whiteBorderSlider.value);
            whiteBorderLabel.textContent = width;
            centerSquare.style.borderWidth = width + 'px';
        }
        
        function updateBlackSize() {
            const size = parseInt(blackSizeSlider.value);
            blackSizeLabel.textContent = size;
            centerSquareBlack.style.width = size + 'px';
            centerSquareBlack.style.height = size + 'px';
        }
        
        function updateBlackBorder() {
            const width = parseInt(blackBorderSlider.value);
            blackBorderLabel.textContent = width;
            centerSquareBlack.style.borderWidth = width + 'px';
        }

        // Car Update Functions
        function updateCarPosition() {
            const x = parseFloat(carPosXSlider.value);
            const y = parseFloat(carPosYSlider.value);
            const z = parseFloat(carPosZSlider.value);
            
            carPosXLabel.textContent = x.toFixed(2);
            carPosYLabel.textContent = y.toFixed(2);
            carPosZLabel.textContent = z.toFixed(2);
            
            // Update all car instances
            gridItems.forEach(item => {
                if (item.car) {
                    item.car.position.set(x, y, z);
                }
            });
        }

        function updateCarRotation() {
            const x = parseInt(carRotXSlider.value);
            const y = parseInt(carRotYSlider.value);
            const z = parseInt(carRotZSlider.value);
            
            carRotXLabel.textContent = x;
            carRotYLabel.textContent = y;
            carRotZLabel.textContent = z;
            
            // Update all car instances
            gridItems.forEach(item => {
                if (item.car) {
                    item.car.rotation.set(
                        THREE.MathUtils.degToRad(x),
                        THREE.MathUtils.degToRad(y),
                        THREE.MathUtils.degToRad(z)
                    );
                }
            });
        }

        function updateCarScale() {
            const scale = parseFloat(carScaleSlider.value);
            
            carScaleLabel.textContent = scale.toFixed(2);
            
            // Update all car instances with uniform scale
            gridItems.forEach(item => {
                if (item.car) {
                    item.car.scale.set(scale, scale, scale);
                }
            });
        }

        spacingSlider.addEventListener('input', updateGridSpacing);
        distSlider.addEventListener('input', updateDistance);
        speedSlider.addEventListener('input', updateSpeed);
        ratioSlider.addEventListener('input', () => {
            ratioLabel.textContent = ratioSlider.value;
            handleResponsiveResize();
        });
        shakeSlider.addEventListener('input', updateShakeVal);
        whiteSizeSlider.addEventListener('input', updateWhiteSize);
        whiteBorderSlider.addEventListener('input', updateWhiteBorder);
        blackSizeSlider.addEventListener('input', updateBlackSize);
        blackBorderSlider.addEventListener('input', updateBlackBorder);
        
        // Car Control Listeners
        carPosXSlider.addEventListener('input', updateCarPosition);
        carPosYSlider.addEventListener('input', updateCarPosition);
        carPosZSlider.addEventListener('input', updateCarPosition);
        carRotXSlider.addEventListener('input', updateCarRotation);
        carRotYSlider.addEventListener('input', updateCarRotation);
        carRotZSlider.addEventListener('input', updateCarRotation);
        carScaleSlider.addEventListener('input', updateCarScale);

        // Light update functions
        function updateLightPosition() {
            const x = parseInt(lightPosXSlider.value);
            const y = parseInt(lightPosYSlider.value);
            const z = parseInt(lightPosZSlider.value);
            
            lightPosXLabel.textContent = x;
            lightPosYLabel.textContent = y;
            lightPosZLabel.textContent = z;
            
            directionLight.position.set(x, y, z);
        }

        function updateDirLightIntensity() {
            const intensity = parseFloat(lightDirIntensitySlider.value);
            lightDirIntensityLabel.textContent = intensity.toFixed(1);
            directionLight.intensity = intensity;
        }

        function updateAmbientIntensity() {
            const intensity = parseFloat(lightAmbientIntensitySlider.value);
            lightAmbientIntensityLabel.textContent = intensity.toFixed(1);
            ambientLight.intensity = intensity;
        }

        function updateDirLightColor() {
            const color = lightDirColorInput.value;
            directionLight.color.set(color);
        }

        // Light Control Listeners
        lightPosXSlider.addEventListener('input', updateLightPosition);
        lightPosYSlider.addEventListener('input', updateLightPosition);
        lightPosZSlider.addEventListener('input', updateLightPosition);
        lightDirIntensitySlider.addEventListener('input', updateDirLightIntensity);
        lightAmbientIntensitySlider.addEventListener('input', updateAmbientIntensity);
        lightDirColorInput.addEventListener('input', updateDirLightColor);

        // Keyboard Navigation
        window.addEventListener('keydown', (e) => {
            const key = e.key.toLowerCase();
            let changed = false;

            if (key === 'w') {
                if (currentGridY < 1) { currentGridY++; changed = true; }
            } else if (key === 's') {
                if (currentGridY > -1) { 
                    currentGridY--; 
                    changed = true;
                    // Trigger down arrow animation
                    arrowDown.classList.add('arrow-shrink-down');
                }
            } else if (key === 'a') {
                // A (Left) -> +Z
                if (currentGridZ < 1) { 
                    currentGridZ++; 
                    changed = true;
                    // Trigger left arrow animation
                    arrowLeft.classList.add('arrow-shrink-left');
                }
            } else if (key === 'd') {
                // D (Right) -> -Z
                if (currentGridZ > -1) { 
                    currentGridZ--; 
                    changed = true;
                    // Trigger right arrow animation
                    arrowRight.classList.add('arrow-shrink-right');
                }
            }

            if (changed) updateTargets();
        });

        window.addEventListener('keyup', (e) => {
            const key = e.key.toLowerCase();
            
            if (key === 'a') {
                // Reset left arrow
                arrowLeft.classList.remove('arrow-shrink-left');
            } else if (key === 'd') {
                // Reset right arrow
                arrowRight.classList.remove('arrow-shrink-right');
            } else if (key === 's') {
                // Reset down arrow
                arrowDown.classList.remove('arrow-shrink-down');
            }
        });

        // Arrow Click Navigation
        const arrowRight = document.getElementById('arrow-image-right');
        const arrowLeft = document.getElementById('arrow-image-left');

        arrowRight.addEventListener('click', () => {
            // Right arrow acts like 'D' key
            if (currentGridZ > -1) {
                currentGridZ--;
                updateTargets();
            }
        });

        arrowLeft.addEventListener('click', () => {
            // Left arrow acts like 'A' key
            if (currentGridZ < 1) {
                currentGridZ++;
                updateTargets();
            }
        });

        // Down Arrow Navigation
        const arrowDown = document.getElementById('arrow-image-down');
        
        arrowDown.addEventListener('click', () => {
            // Down arrow acts like 'S' key
            if (currentGridY > -1) {
                currentGridY--;
                updateTargets();
            }
        });

        // Load Models
        const loader = new GLTFLoader();
        
        const dracoLoader = new DRACOLoader();
        dracoLoader.setDecoderPath('https://www.gstatic.com/draco/versioned/decoders/1.5.6/');
        loader.setDRACOLoader(dracoLoader);

        // Base models
        let baseBoxModel = null;
        let baseCarBodyModel = null;      // carOne
        let baseCarTwoBodyModel = null;   // carTwo
        let baseWheelModel = null;
        let modelsLoaded = 0;
        const totalModels = 4;

        // Car configuration (from car-debug.html)
        const carConfig = {
            bodyScale: 5.0,
            bodyY: -0.30,
            bodyRotY: 180, // degrees
            wheelX: 0.80,
            wheelY: 0.35,
            wheelRearZ: 0.65,
            wheelFrontZ: -1.00
        };

        // Load box.glb
        loader.load('./box.glb', (gltf) => {
            baseBoxModel = gltf.scene;
            modelsLoaded++;
            console.log('âœ… box.glb loaded');
            if (modelsLoaded === totalModels) createGrid();
        }, undefined, (error) => {
            console.error('âŒ Error loading box.glb:', error);
        });

        // Load carOne.glb (body)
        loader.load('./carOne.glb', (gltf) => {
            baseCarBodyModel = gltf.scene;
            modelsLoaded++;
            console.log('âœ… carOne.glb loaded');
            if (modelsLoaded === totalModels) createGrid();
        }, undefined, (error) => {
            console.error('âŒ Error loading carOne.glb:', error);
        });

        // Load carTwo.glb (second car body)
        loader.load('./carTwo.glb', (gltf) => {
            baseCarTwoBodyModel = gltf.scene;
            modelsLoaded++;
            console.log('âœ… carTwo.glb loaded');
            if (modelsLoaded === totalModels) createGrid();
        }, undefined, (error) => {
            console.error('âŒ Error loading carTwo.glb:', error);
        });

        // Load steerOne.glb (wheel)
        loader.load('./steerOne.glb', (gltf) => {
            baseWheelModel = gltf.scene;
            modelsLoaded++;
            console.log('âœ… steerOne.glb loaded');
            if (modelsLoaded === totalModels) createGrid();
        }, undefined, (error) => {
            console.error('âŒ Error loading steerOne.glb:', error);
        });

        function createCarGroup(carType = 'carOne', isLocked = false) {
            // Get transform values from sliders
            const carPos = {
                x: parseFloat(carPosXSlider.value),
                y: parseFloat(carPosYSlider.value),
                z: parseFloat(carPosZSlider.value)
            };
            const carRot = {
                x: parseInt(carRotXSlider.value),
                y: parseInt(carRotYSlider.value),
                z: parseInt(carRotZSlider.value)
            };
            const carScale = parseFloat(carScaleSlider.value);

            // Create car group
            const carGroup = new THREE.Group();

            // Select body model based on carType
            const bodyModelBase = carType === 'carTwo' ? baseCarTwoBodyModel : baseCarBodyModel;
            
            // Clone and add body
            const carBody = bodyModelBase.clone();
            
            // Unlit black material for locked cars
            const lockedMaterial = new THREE.MeshBasicMaterial({ color: 0x111111 });
            
            carBody.traverse((child) => {
                if (child.isMesh) {
                    if (isLocked) {
                        child.material = lockedMaterial;
                    }
                    child.castShadow = !isLocked;
                    child.receiveShadow = !isLocked;
                }
            });
            
            // Apply body config from car-debug.html
            carBody.scale.set(carConfig.bodyScale, carConfig.bodyScale, carConfig.bodyScale);
            carBody.position.y = carConfig.bodyY;
            carBody.rotation.y = (carConfig.bodyRotY * Math.PI) / 180;
            carGroup.add(carBody);

            // Create 4 wheels
            const wheelPositions = [
                { x: -carConfig.wheelX, y: carConfig.wheelY, z: carConfig.wheelRearZ, flip: true },   // Rear Left
                { x: carConfig.wheelX, y: carConfig.wheelY, z: carConfig.wheelRearZ, flip: false },   // Rear Right
                { x: -carConfig.wheelX, y: carConfig.wheelY, z: carConfig.wheelFrontZ, flip: true },  // Front Left
                { x: carConfig.wheelX, y: carConfig.wheelY, z: carConfig.wheelFrontZ, flip: false }   // Front Right
            ];

            wheelPositions.forEach((pos, i) => {
                const wheelGroup = new THREE.Group();
                const wheelMesh = baseWheelModel.clone();
                
                wheelMesh.scale.set(carConfig.bodyScale, carConfig.bodyScale, carConfig.bodyScale);
                wheelMesh.traverse((child) => {
                    if (child.isMesh) {
                        if (isLocked) {
                            child.material = lockedMaterial;
                        }
                        child.castShadow = !isLocked;
                        child.receiveShadow = !isLocked;
                    }
                });

                // Left-side wheels need to be flipped so hub faces outward
                if (pos.flip) {
                    wheelGroup.rotation.y = Math.PI;
                }

                wheelGroup.add(wheelMesh);
                wheelGroup.position.set(pos.x, pos.y, pos.z);
                carGroup.add(wheelGroup);
            });

            // Add lock emoji sprite for locked cars
            if (isLocked) {
                const canvas = document.createElement('canvas');
                canvas.width = 128;
                canvas.height = 128;
                const ctx = canvas.getContext('2d');
                ctx.font = '100px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('ðŸ”’', 64, 64);
                
                const texture = new THREE.CanvasTexture(canvas);
                const spriteMaterial = new THREE.SpriteMaterial({ 
                    map: texture, 
                    transparent: true,
                    depthTest: false
                });
                const lockSprite = new THREE.Sprite(spriteMaterial);
                lockSprite.scale.set(0.4, 0.4, 1);
                lockSprite.position.set(0, 0.5, 0); // Above the car
                lockSprite.visible = false; // Hidden by default, shown when selected
                carGroup.add(lockSprite);
                carGroup.userData.lockSprite = lockSprite; // Store reference
            }

            // Apply user transforms to the entire car group
            carGroup.position.set(carPos.x, carPos.y, carPos.z);
            carGroup.rotation.set(
                THREE.MathUtils.degToRad(carRot.x),
                THREE.MathUtils.degToRad(carRot.y),
                THREE.MathUtils.degToRad(carRot.z)
            );
            carGroup.scale.set(carScale, carScale, carScale);

            return carGroup;
        }

        function createGrid() {
            // Create a 3x3 Grid centered at (0,0,0)
            // Camera is at X=5, so the grid should be on the YZ plane (Y: Up/Down, Z: Left/Right)
            // Grid layout (from camera view):
            // z: 1 (left), 0 (center), -1 (right)
            // y: 1 (up), 0 (center), -1 (down)
            
            for (let y = -1; y <= 1; y++) {
                for (let z = -1; z <= 1; z++) {
                    const boxModel = baseBoxModel.clone();
                    
                    // Clone Materials to allow independent coloring + enable shadows
                    const instanceMaterials = [];
                    boxModel.traverse((child) => {
                        if (child.isMesh) {
                            child.material = child.material.clone();
                            instanceMaterials.push(child.material);
                            child.receiveShadow = true; // Box receives shadows
                        }
                    });

                    scene.add(boxModel);
                    
                    // Determine car type and locked state based on position
                    // Center (0,0) = carOne unlocked
                    // Right of center (0,-1) = carTwo unlocked
                    // All others = carOne locked (black silhouette)
                    let carType = 'carOne';
                    let isLocked = true;
                    
                    if (y === 0 && z === 0) {
                        // Center cell - carOne unlocked
                        carType = 'carOne';
                        isLocked = false;
                    } else if (y === 0 && z === -1) {
                        // Right of center - carTwo unlocked
                        carType = 'carTwo';
                        isLocked = false;
                    }
                    // All other cells remain locked with carOne
                    
                    // Create full car with wheels
                    const carGroup = createCarGroup(carType, isLocked);
                    boxModel.add(carGroup);
                    
                    // Store item with its materials, color state, and car reference
                    gridItems.push({ 
                        mesh: boxModel, 
                        gridY: y, 
                        gridZ: z,
                        materials: instanceMaterials,
                        targetColor: new THREE.Color(0xffffff),
                        car: carGroup,
                        isLocked: isLocked
                    });
                }
            }
            
            // Apply initial spacing and targets
            updateGridSpacing();
            updateTargets();
            
            console.log('Grid loaded successfully with cars');
        }
        // Handle Window Resize
        // Handle Window Resize
        // Ratios:
        // White Square / Cam Distance = 460 / 2.0 = 230
        // Black Square / White Square = 480 / 460 = 1.043478
        // White Border / White Square = 30 / 460 = 0.065217
        // Black Border / Black Square = 11 / 480 = 0.022916
        
        const RATIO_PX_PER_CAM_UNIT = 230;
        const BLACK_TO_WHITE_RATIO = 480 / 460;
        const WHITE_BORDER_RATIO = 30 / 460;
        const BLACK_BORDER_RATIO = 11 / 480;

        function handleResponsiveResize() {
            // Apply minimum width constraint for ALL calculations
            const rawWidth = window.innerWidth;
            const minWidth = 550; 
            const width = Math.max(minWidth, rawWidth); // Effective width used for logic
            
            const height = 1000; // Fixed height for calculations
            
            // Determine White Square Size based on viewport
            // Use 55% of min dimension as base
            const minDim = Math.min(width, height);
            let targetWhiteSize = Math.round(minDim * 0.55);
            
            // Clamp: Don't go smaller than 150px, don't go larger than 500px
            const clampedWhiteSize = Math.max(150, Math.min(500, targetWhiteSize));
            
            // Calculate Black Size using RATIO, not fixed difference
            const clampedBlackSize = Math.round(clampedWhiteSize * BLACK_TO_WHITE_RATIO);
            
            // Adjust FOV based on Aspect Ratio
            const REF_FOV = 75;
            let newFov = REF_FOV;
            const aspect = width / height;

            if (aspect < 1.0) {
                // In portrait mode, widen FOV to keep content visible horizontally
                const hFOV = 2 * Math.atan(Math.tan((REF_FOV * Math.PI / 180) / 2) * 1.0);
                newFov = 2 * Math.atan(Math.tan(hFOV / 2) / aspect) * (180 / Math.PI);
                
                // Cap max FOV to avoid extreme fish-eye
                newFov = Math.min(110, newFov);
            }

            // Apply FOV
            camera.fov = newFov;
            camera.updateProjectionMatrix();

            // Calculate Borders
            const clampedWhiteBorder = Math.max(2, Math.round(clampedWhiteSize * WHITE_BORDER_RATIO));
            const clampedBlackBorder = Math.max(1, Math.round(clampedBlackSize * BLACK_BORDER_RATIO));
            
            // Apply CSS
            centerSquare.style.width = clampedWhiteSize + 'px';
            centerSquare.style.height = clampedWhiteSize + 'px';
            centerSquare.style.borderWidth = clampedWhiteBorder + 'px';
            
            centerSquareBlack.style.width = clampedBlackSize + 'px';
            centerSquareBlack.style.height = clampedBlackSize + 'px';
            centerSquareBlack.style.borderWidth = clampedBlackBorder + 'px';
            
            // Update UI Sliders (Visual Feedback) - Squares only, Cam Distance is now manual
            whiteSizeSlider.value = clampedWhiteSize;
            whiteSizeLabel.textContent = clampedWhiteSize;
            whiteBorderSlider.value = clampedWhiteBorder;
            whiteBorderLabel.textContent = clampedWhiteBorder;
            
            blackSizeSlider.value = clampedBlackSize;
            blackSizeLabel.textContent = clampedBlackSize;
            blackBorderSlider.value = clampedBlackBorder;
            blackBorderLabel.textContent = clampedBlackBorder;
            
            // Fixed Height Renderer
            const fixedHeight = 1000;
            camera.aspect = width / fixedHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(width, fixedHeight);
        }

        window.addEventListener('resize', handleResponsiveResize);
        
        // Initial call
        setTimeout(handleResponsiveResize, 100);

        // Animation Loop
        function animate() {
            requestAnimationFrame(animate);
            
            const lerpSpeed = parseFloat(speedSlider.value);
            
            // Shake Params
            const decay = parseFloat(shakeLenSlider.value);
            const freq = parseFloat(shakeSpdSlider.value);

            // Smoothly interpolate camera and target
            controls.target.lerp(targetLookAt, lerpSpeed);
            camera.position.lerp(targetCamPos, lerpSpeed);
            
            // Apply Shake (Smooth Sine Wave)
            if (currentShake > 0.001) {
                const time = Date.now() * 0.001;
                
                // Use Sin/Cos for smooth motion - only Y and Z, not X (depth)
                const ry = Math.cos(time * freq) * currentShake;
                const rz = Math.sin(time * freq * 1.3) * currentShake; // 1.3 to de-sync Y/Z
                
                // Add offset to camera position (0 on X to avoid moving towards/away from object)
                // Note: since we lerp 'camera.position' each frame, simply adding to it 
                // creates a temporary deviation which the lerp pulls back, acting like a spring.
                camera.position.add(new THREE.Vector3(0, ry, rz)); 
                
                // Decay shake
                currentShake *= decay;
            } else {
                currentShake = 0;
            }
            
            // Interpolate Colors
            gridItems.forEach(item => {
                if (item.materials && item.targetColor) {
                    item.materials.forEach(mat => {
                        mat.color.lerp(item.targetColor, lerpSpeed); 
                    });
                }
            });

            controls.update(); // Update controls for damping
            renderer.render(scene, camera);
        }
        animate();
    </script>
</body>

</html>