<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ninja Slice Master</title>
    <!-- Tailwind CSS CDN for aesthetics -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { 
            font-family: "Inter", sans-serif; 
            background-color: #1a1a2e; /* Koyu Ninja temasƒ± */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            overflow: hidden; /* Dikey kaydƒ±rmayƒ± engelle */
        }
        #main-container {
            max-width: 450px; /* Sabit bir maksimum geni≈ülik */
            width: 100%;
        }
        #gameCanvas {
            border: 4px solid #e94560; /* Kƒ±rmƒ±zƒ±msƒ±-pembe kenarlƒ±k */
            background-color: #0f3460; /* Koyu Mavi Oyun Alanƒ± */
            box-shadow: 0 0 20px rgba(233, 69, 96, 0.7);
            cursor: pointer;
            width: 400px;
            height: 600px;
            display: block;
        }
        .ui-panel {
            background-color: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(2px);
            border-radius: 8px;
            padding: 1rem 0.5rem;
            color: white;
            flex-grow: 1;
            margin: 0 5px;
            text-align: center;
            min-width: 100px;
            font-size: 1.1rem;
        }
        /* Oyun Bilgisi Paneli */
        #game-info {
            width: 100%;
            display: flex;
            justify-content: space-around;
        }
        /* Boss Can Barƒ± i√ßin √∂zel stil */
        #boss-health-bar {
            background-color: #333;
            border: 1px solid white;
            border-radius: 5px;
            overflow: hidden;
            height: 20px;
            width: 400px; /* Canvas ile aynƒ± geni≈ülikte */
            max-width: 400px;
            margin-bottom: 10px;
            display: none; /* Boss yokken gizli */
        }
        #boss-health-fill {
            height: 100%;
            background-color: #ff3864; /* Kƒ±rmƒ±zƒ± dolgu */
            transition: width 0.1s ease-out;
        }
        /* G√º√ßlendirme Durum Mesajƒ± ve Saya√ß */
        #powerup-status {
            position: absolute;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            color: #ffcc00; /* Sarƒ±msƒ± renk */
            background-color: rgba(0, 0, 0, 0.7);
            border: 2px solid #ffcc00;
            font-weight: bold;
            display: none;
            z-index: 10;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 1rem;
            min-width: 250px;
            text-align: center;
            box-shadow: 0 0 10px rgba(255, 204, 0, 0.5);
        }

        /* Mobil Uyumlu D√ºzenleme (Ekran geni≈üliƒüi 450px'ten k√º√ß√ºk olduƒüunda) */
        @media (max-width: 450px) {
            #main-container {
                padding: 10px;
                max-width: 100vw;
            }
            #gameCanvas, #boss-health-bar {
                width: 95vw; /* Ekranƒ±n %95'ini kullan */
                height: calc(95vw * 1.5); /* 400x600 oranƒ±nƒ± koru */
                max-width: 400px;
                max-height: 600px;
            }
            .ui-panel {
                padding: 0.5rem 0.2rem;
                font-size: 0.9rem;
            }
            h1 {
                font-size: 1.75rem !important;
            }
        }
    </style>
</head>
<body>
    <div id="main-container" class="flex flex-col items-center p-4 relative">
        
        <h1 class="text-3xl sm:text-4xl font-extrabold text-[#e94560] mb-4 tracking-wide text-center">
            ‚≠ê NINJA SLICE MASTER ‚≠ê
        </h1>

        <!-- Oyun Bilgisi Paneli -->
        <div id="game-info" class="mb-4">
            <div class="font-bold ui-panel">Seviye: <span id="levelDisplay">1</span></div>
            <div class="font-bold ui-panel">Skor: <span id="scoreDisplay">0</span></div>
            <div class="font-bold ui-panel">Can: <span id="missedDisplay">3</span></div>
        </div>

        <!-- Destek Durum Mesajƒ± ve Saya√ß -->
        <div id="powerup-status" class="status-message">
            DESTEK AKTƒ∞F!
        </div>

        <!-- Boss Can Barƒ± (Canvas altƒ±nda) -->
        <div id="boss-health-bar">
            <div id="boss-health-fill" style="width: 100%;"></div>
        </div>

        <!-- Canvas Oyun Alanƒ± -->
        <!-- Boyutlar JS ile ayarlanacaƒüƒ± i√ßin burada varsayƒ±lan deƒüerler tutulur -->
        <canvas id="gameCanvas" width="400" height="600"></canvas>
        
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreDisplay = document.getElementById('scoreDisplay');
        const missedDisplay = document.getElementById('missedDisplay');
        const levelDisplay = document.getElementById('levelDisplay');
        const bossHealthBar = document.getElementById('boss-health-bar');
        const bossHealthFill = document.getElementById('boss-health-fill');
        const powerupStatusEl = document.getElementById('powerup-status');
        
        // Oyun Sabitleri
        const FRUITS_LIST = ['üçé', 'üçä', 'üçã', 'ü•ù', 'üçâ', 'üçç', 'üçí'];
        const GIFT_EMOJI = '‚ù§Ô∏è'; // Can Veren Hediye
        const SUPPORT_GIFT_EMOJI = 'üì¶'; // Destek Ninjasƒ± √áaƒüƒ±ran Hediye
        const GIFT_CHANCE = 0.15; 
        const SPECIAL_GIFT_SPAWN_THRESHOLD = 10; 
        const MAX_LIVES = 3;
        const GIFT_HEAL_AMOUNT = 1;
        const GIFT_OVERHEAL_SCORE = 25; 
        const GRAVITY = 0.12; 
        const FRUIT_SIZE = 30; 
        const BOSS_MAX_HEALTH = 150; 
        const BOSS_DAMAGE_PER_HIT = 1;
        const SCORE_MULTIPLIER = 2; 
        
        // DESTEK Nƒ∞NJASI AYARLARI
        const SUPPORT_NINJA_OFFSET = 40;
        const SUPPORT_NINJA_FIRE_RATE = 200;
        const SUPPORT_NINJA_DURATION_MS = 15000; // 15 saniye

        // KULLANICI ƒ∞STEƒûƒ∞: Oyunu 8. seviyeden ba≈ülatmak i√ßin index 7'ye ayarlandƒ±.
        const START_LEVEL_INDEX = 7; 

        // Silah Tiplerine G√∂re Ayarlar
        const WEAPON_CONFIG = {
            's1': { size: 20, speed: 15, symbol: '‚≠ê', color: 'white', fireCount: 1, spread: 0, piercing: false },
            's2': { size: 20, speed: 15, symbol: '‚öîÔ∏è', color: 'silver', fireCount: 2, spread: 20, piercing: false },
            's3': { size: 20, speed: 15, symbol: 'ü•∑', color: 'red', fireCount: 3, spread: 25, piercing: false },
            'l1': { size: 25, speed: 20, symbol: 'üí•', color: 'yellow', fireCount: 1, spread: 0, piercing: false }, 
            'l2': { size: 25, speed: 20, symbol: 'üåÄ', color: 'cyan', fireCount: 2, spread: 25, piercing: false }, 
            'l3': { size: 25, speed: 20, symbol: 'üéØ', color: 'orange', fireCount: 3, spread: 30, piercing: false }, 
            'xl1': { size: 30, speed: 25, symbol: 'üî•', color: 'red', fireCount: 1, spread: 0, piercing: false }, 
            'xl2': { size: 30, speed: 25, symbol: '‚ú®', color: 'gold', fireCount: 2, spread: 20, piercing: false }, 
            'xl3': { size: 30, speed: 25, symbol: 'üëë', color: 'purple', fireCount: 3, spread: 25, piercing: true }, 
        };
        
        // Seviye Tasarƒ±mƒ± ve ƒ∞lerleme Ko≈üullarƒ±
        const LEVELS = [
            { level: 1, name: 'Tek Bƒ±√ßak', scoreToAdvance: 50 * SCORE_MULTIPLIER, spawnRate: 2000, projectileType: 's1', fruitSpeedMod: 1.0 },
            { level: 2, name: '√áift Bƒ±√ßak', scoreToAdvance: 150 * SCORE_MULTIPLIER, spawnRate: 1800, projectileType: 's2', fruitSpeedMod: 1.05 },
            { level: 3, name: '√ú√ßl√º Bƒ±√ßak', scoreToAdvance: 300 * SCORE_MULTIPLIER, spawnRate: 1700, projectileType: 's3', fruitSpeedMod: 1.1 },
            { level: 4, name: 'B√ºy√ºk Tek', scoreToAdvance: 500 * SCORE_MULTIPLIER, spawnRate: 1600, projectileType: 'l1', fruitSpeedMod: 1.15 },
            { level: 5, name: 'B√ºy√ºk ƒ∞kili', scoreToAdvance: 750 * SCORE_MULTIPLIER, spawnRate: 1500, projectileType: 'l2', fruitSpeedMod: 1.2 },
            { level: 6, name: 'B√ºy√ºk √ú√ßl√º', scoreToAdvance: 1050 * SCORE_MULTIPLIER, spawnRate: 1400, projectileType: 'l3', fruitSpeedMod: 1.25 },
            { level: 7, name: 'Ultra ƒ∞kili', scoreToAdvance: 1400 * SCORE_MULTIPLIER, spawnRate: 1300, projectileType: 'xl2', fruitSpeedMod: 1.30 },
            { level: 8, name: 'Ultra √ú√ßl√º', scoreToAdvance: 1800 * SCORE_MULTIPLIER, spawnRate: 1200, projectileType: 'xl3', fruitSpeedMod: 1.35 },
            { level: 9, name: '√úst√ºn Salvo', scoreToAdvance: 2300 * SCORE_MULTIPLIER, spawnRate: 1100, projectileType: 'xl3', fruitSpeedMod: 1.50 },
            { level: 10, name: 'BOSS SAVA≈ûI', scoreToAdvance: Infinity, spawnRate: 0, projectileType: 'xl3', fruitSpeedMod: 1.6 } 
        ];

        // Oyun Durumu
        let score = 0;
        let missedCount = 0; 
        let isGameRunning = false;
        let fruits = [];
        let shurikens = [];
        let fruitSpawnInterval;
        let lastUpdateTime = 0;
        let currentLevelIndex = 0; 
        let boss = null;
        
        // G√ú√áLENDƒ∞RME DURUMU
        let supportNinjaActiveUntil = 0; 
        let fruitsSpawnedSinceLevelUp = 0;
        let isSpecialGiftActive = false; 
        let lastSupportNinjaFire = 0;
        let lastPlayerFire = 0; 
        
        let ninjaX = canvas.width / 2;
        
        // ---------- BOSS Sƒ±nƒ±fƒ± ----------
        class Boss {
            constructor() {
                this.x = canvas.width / 2;
                this.y = canvas.height / 4;
                this.radius = 50;
                this.health = BOSS_MAX_HEALTH;
                this.maxHealth = BOSS_MAX_HEALTH;
                this.vx = 2; 
                this.symbol = 'üëπ'; 
            }
            update() {
                this.x += this.vx;
                if (this.x + this.radius > canvas.width || this.x - this.radius < 0) {
                    this.vx *= -1;
                }
            }
            draw() {
                ctx.font = `${this.radius * 2}px Arial`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(this.symbol, this.x, this.y);

                bossHealthBar.style.display = 'block';
                // Can barƒ±nƒ± canvas geni≈üliƒüine g√∂re yeniden boyutlandƒ±r
                bossHealthBar.style.width = canvas.width + 'px'; 
                bossHealthFill.style.width = `${(this.health / this.maxHealth) * 100}%`;
            }
            takeDamage() {
                this.health -= BOSS_DAMAGE_PER_HIT;
                if (this.health <= 0) {
                    return true;
                }
                return false;
            }
        }
        
        // ---------- Shuriken Sƒ±nƒ±fƒ± ----------
        class Shuriken {
            constructor(x, y, config, initialVx = 0) { 
                this.x = x + initialVx; 
                this.y = y;
                this.config = config;
                this.size = config.size;
                this.vy = -config.speed;
                this.vx = initialVx * 0.1; 
                this.rotation = 0;
                this.isHit = false;
                this.isPiercing = config.piercing || false;
            }
            update() {
                if (this.isHit) return;
                this.x += this.vx;
                this.y += this.vy;
                this.rotation += 0.3 * (this.config.speed / 15); 
                if (this.y < 0) {
                    this.isHit = true; 
                }
            }
            draw() {
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.rotate(this.rotation);
                
                ctx.font = `${this.size}px Arial`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(this.config.symbol, 0, 0);
                ctx.restore();
            }
        }

        // ---------- Meyve/Hediye Sƒ±nƒ±fƒ± ----------
        class Fruit {
            constructor(speedMod, isGift = false, isSupportGift = false) {
                this.size = FRUIT_SIZE; 
                this.x = Math.random() * (canvas.width - 2 * this.size) + this.size;
                this.vx = (Math.random() - 0.5) * 1.5; 
                this.y = canvas.height + this.size; 
                this.vy = (-9 - Math.random() * 4) * speedMod; 
                
                this.isGift = isGift;
                this.isSupportGift = isSupportGift;
                
                if (isSupportGift) {
                    this.emoji = SUPPORT_GIFT_EMOJI;
                    isSpecialGiftActive = true; 
                } else if (isGift) {
                    this.emoji = GIFT_EMOJI;
                } else {
                    this.emoji = FRUITS_LIST[Math.floor(Math.random() * FRUITS_LIST.length)];
                }
                
                this.isSliced = false;
                this.slicedParts = []; 
                this.isMissed = false;
            }

            update() {
                if (this.isSliced) {
                    this.slicedParts.forEach(part => {
                        part.x += part.vx;
                        part.y += part.vy;
                        part.vy += GRAVITY * 1.5; 
                    });
                    
                    if (this.slicedParts[0].y > canvas.height + 50) {
                        this.isMissed = true; 
                    }

                } else {
                    this.x += this.vx;
                    this.y += this.vy;
                    this.vy += GRAVITY; 
                    
                    const fruitRadius = this.size; 
                    
                    if (this.x + fruitRadius > canvas.width || this.x - fruitRadius < 0) {
                        this.vx *= -1; 
                        if (this.x + fruitRadius > canvas.width) {
                            this.x = canvas.width - fruitRadius - 1; 
                        } else if (this.x - fruitRadius < 0) {
                            this.x = fruitRadius + 1;
                        }
                    }

                    if (this.y > canvas.height + this.size && !this.isMissed) {
                        this.isMissed = true;
                        
                        // √ñzel hediyeler (Sadece Destek) ka√ßtƒ±ƒüƒ±nda bayraƒüƒ± sƒ±fƒ±rla
                        if (this.isSupportGift) {
                            isSpecialGiftActive = false; 
                        }
                        
                        // Hediye ka√ßƒ±rƒ±lƒ±rsa can gitmez
                        if (!this.isGift && !this.isSupportGift) {
                            missedCount++;
                        }
                        
                        updateUI();
                        if (missedCount >= MAX_LIVES) {
                            endGame();
                        }
                    }
                }
            }

            draw() {
                if (this.isSliced) {
                    this.slicedParts.forEach(part => {
                        ctx.font = `${this.size * 0.8}px Arial`;
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillText(part.emoji, part.x, part.y);
                    });
                } else {
                    ctx.font = `${this.size * 2}px Arial`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(this.emoji, this.x, this.y);
                }
            }
            
            slice() {
                this.isSliced = true;
                
                if (this.isSupportGift) {
                    // DESTEK HEDƒ∞YESƒ∞ KESƒ∞LDƒ∞
                    isSpecialGiftActive = false; 
                    if (Date.now() >= supportNinjaActiveUntil) {
                        supportNinjaActiveUntil = Date.now() + SUPPORT_NINJA_DURATION_MS; 
                        score += 50; 
                    } else {
                        score += 10; 
                    }

                } else if (this.isGift) {
                    // CAN HEDƒ∞YESƒ∞ KESƒ∞LDƒ∞
                    if (missedCount > 0) {
                        missedCount = Math.max(0, missedCount - GIFT_HEAL_AMOUNT);
                        score += 25; 
                    } else {
                        score += GIFT_OVERHEAL_SCORE; 
                    }
                } else {
                    // Normal meyve kesildi
                    score += 10;
                }
                
                checkLevelCompletion(); 
                updateUI();

                // Par√ßalar olu≈ütur
                for (let i = 0; i < 2; i++) {
                    this.slicedParts.push({
                        emoji: this.emoji,
                        x: this.x,
                        y: this.y,
                        vx: this.vx + (i === 0 ? 3 : -3) * Math.random(),
                        vy: this.vy / 2 - Math.random() * 3,
                    });
                }
            }

            checkCollision(shuriken) {
                if (this.isSliced) return false;

                const dx = shuriken.x - this.x;
                const dy = shuriken.y - this.y;
                const distance = Math.sqrt(dx * dx + dy * dy);

                if (distance < this.size + shuriken.size / 2) {
                    this.slice();
                    return true;
                }
                return false;
            }
        }

        // ---------- Oyun Mekaniƒüi Fonksiyonlarƒ± ----------
        
        function checkLevelCompletion() {
            const currentLevel = LEVELS[currentLevelIndex];
            
            if (score >= currentLevel.scoreToAdvance && currentLevelIndex < LEVELS.length - 1) {
                advanceLevel();
            }
        }
        
        function advanceLevel() {
            currentLevelIndex++;
            // Yeni Level: T√ºm g√º√ßlendirmeler sƒ±fƒ±rlanƒ±r
            supportNinjaActiveUntil = 0; 
            fruitsSpawnedSinceLevelUp = 0;
            isSpecialGiftActive = false;
            
            const newLevel = LEVELS[currentLevelIndex];
            
            if (newLevel.level === 10) {
                startBossFight(newLevel);
            } else {
                if (fruitSpawnInterval) clearInterval(fruitSpawnInterval);
                fruitSpawnInterval = setInterval(spawnFruit, newLevel.spawnRate, newLevel.fruitSpeedMod);
            }
            
            drawLevelUpScreen(true, newLevel);
            updateUI();
        }
        
        function startBossFight(levelConfig) {
            boss = new Boss();
            supportNinjaActiveUntil = 0;
            if (fruitSpawnInterval) clearInterval(fruitSpawnInterval);
            missedCount = 0; 
            updateUI();
        }

        function updateUI() {
            scoreDisplay.textContent = score;
            missedDisplay.textContent = `${MAX_LIVES - missedCount}`; 
            levelDisplay.textContent = LEVELS[currentLevelIndex].level;
        }

        // ---------- DESTEK Nƒ∞NJASI LOGƒ∞ƒûƒ∞ ----------

        function drawSupportNinja() {
            const ninjaSize = 15;
            const ninjaXPos = ninjaX - SUPPORT_NINJA_OFFSET; 
            const ninjaYPos = canvas.height - 15;

            // Destek Ninjasƒ± Dairesi (Kƒ±rmƒ±zƒ±)
            ctx.fillStyle = '#ff0000'; 
            ctx.beginPath();
            ctx.arc(ninjaXPos, ninjaYPos, ninjaSize, 0, Math.PI * 2); 
            ctx.fill();
        }

        function supportNinjaFire() {
            if (Date.now() >= lastSupportNinjaFire + SUPPORT_NINJA_FIRE_RATE) {
                const fireX = ninjaX - SUPPORT_NINJA_OFFSET;
                const fireY = canvas.height - 15;
                fireProjectile(fireX, fireY, true); 
                lastSupportNinjaFire = Date.now();
            }
        }
        
        function drawGameScreen(elapsed) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const isSupportActive = Date.now() < supportNinjaActiveUntil;
            
            powerupStatusEl.style.display = 'none';

            if (isSupportActive) {
                const remainingTime = Math.ceil((supportNinjaActiveUntil - Date.now()) / 1000);
                powerupStatusEl.style.display = 'block';
                powerupStatusEl.textContent = `DESTEK AKTƒ∞F! [${remainingTime}s]`;
                drawSupportNinja();
                supportNinjaFire();
            }
            
            shurikens.forEach(shuriken => shuriken.update());
            shurikens.forEach(shuriken => shuriken.draw());
            
            if (boss) {
                // BOSS LOGIC 
                boss.update();
                boss.draw();
                
                shurikens.forEach(shuriken => {
                    const dx = shuriken.x - boss.x;
                    const dy = shuriken.y - boss.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);

                    if (distance < boss.radius + shuriken.size / 2) {
                        if (!shuriken.isHit) { 
                             if (boss.takeDamage()) {
                                endGame(true); 
                                return;
                            }
                            if (!shuriken.isPiercing) {
                                shuriken.isHit = true; 
                            }
                        }
                    }
                });
                fruits = []; 
                
            } else {
                // Meyveler ve √áarpƒ±≈üma (Normal seviyeler)
                fruits.forEach(fruit => fruit.update());
                fruits.forEach(fruit => fruit.draw());
                
                shurikens.forEach(shuriken => {
                    fruits.forEach(fruit => {
                        if (!shuriken.isHit && fruit.checkCollision(shuriken)) {
                            if (!shuriken.isPiercing) {
                                shuriken.isHit = true; 
                            }
                        }
                    });
                });
                
                bossHealthBar.style.display = 'none';
            }
            
            fruits = fruits.filter(fruit => !fruit.isMissed); 
            shurikens = shurikens.filter(shuriken => !shuriken.isHit); 

            // ANA NINJA KOLU/ELƒ∞ √áƒ∞Zƒ∞Mƒ∞ (Kƒ±rmƒ±zƒ±msƒ±-pembe)
            ctx.fillStyle = '#e94560'; 
            ctx.beginPath();
            const ninjaY = canvas.height - 15;
            ctx.arc(ninjaX, ninjaY, 15, 0, Math.PI * 2); 
            ctx.fill();
        }

        function gameLoop(currentTime) {
            if (!isGameRunning) return;

            const elapsed = currentTime - lastUpdateTime;
            drawGameScreen(elapsed);

            lastUpdateTime = currentTime;
            requestAnimationFrame(gameLoop);
        }

        function spawnFruit() {
            if (isGameRunning && !boss) {
                let isGift = false;
                let isSupportGift = false;
                
                // √ñzel hediye √ßƒ±kƒ±≈ü ko≈üulu: Ekranda √∂zel hediye yok VE yeterli meyve doƒüdu (10 adet).
                if (fruitsSpawnedSinceLevelUp >= SPECIAL_GIFT_SPAWN_THRESHOLD && !isSpecialGiftActive) {
                    
                    isSupportGift = true;
                    fruitsSpawnedSinceLevelUp = 0; 
                } 
                
                // Normal Hediye Kontrol√º (%15 ≈üans, √∂zel hediye √ßƒ±kmayacaksa)
                else if (Math.random() < GIFT_CHANCE && !isSpecialGiftActive) {
                    isGift = true;
                }
                
                fruits.push(new Fruit(LEVELS[currentLevelIndex].fruitSpeedMod, isGift, isSupportGift));
                
                // √ñzel hediye √ßƒ±kmadƒ±ƒüƒ± s√ºrece sayacƒ± artƒ±r
                if (!isSupportGift) {
                     fruitsSpawnedSinceLevelUp++;
                }
            }
        }
        
        function fireProjectile(x, y, isSupport = false) {
            // Oyuncu atƒ±≈ü hƒ±zƒ± limiti
            if (!isSupport && Date.now() < lastPlayerFire + 100) return; 

            const currentWeapon = LEVELS[currentLevelIndex].projectileType;
            const config = WEAPON_CONFIG[currentWeapon];
            
            if (config.fireCount === 1) {
                shurikens.push(new Shuriken(x, y, config));
                
                if (isSupport) {
                     shurikens[shurikens.length - 1].vy *= 0.8; 
                }
                return;
            }

            const spreadAmount = config.spread / 2;
            const totalCount = config.fireCount;
            
            for (let i = 0; i < totalCount; i++) {
                const offset = (i - (totalCount - 1) / 2) * spreadAmount;
                shurikens.push(new Shuriken(x, y, config, offset));
                if (isSupport) {
                     shurikens[shurikens.length - 1].vy *= 0.8; 
                }
            }
            
            if (!isSupport) {
                lastPlayerFire = Date.now(); 
            }
        }

        // ---------- Oyun Durum Kontrol√º ----------

        function startGame() {
            score = 0;
            missedCount = 0;
            currentLevelIndex = START_LEVEL_INDEX; 
            fruits = [];
            shurikens = [];
            boss = null;
            supportNinjaActiveUntil = 0;
            fruitsSpawnedSinceLevelUp = 0;
            isSpecialGiftActive = false;
            isGameRunning = true;
            
            updateUI();
            
            currentButton = null;
            drawGameOverScreen(false);
            
            const initialLevelConfig = LEVELS[currentLevelIndex];
            
            if (fruitSpawnInterval) clearInterval(fruitSpawnInterval);
            if (initialLevelConfig.level === 10) {
                 startBossFight(initialLevelConfig); 
            } else {
                 fruitSpawnInterval = setInterval(spawnFruit, initialLevelConfig.spawnRate, initialLevelConfig.fruitSpeedMod);
            }

            requestAnimationFrame(gameLoop);
        }

        function endGame(isWin = false) {
            isGameRunning = false;
            clearInterval(fruitSpawnInterval);
            supportNinjaActiveUntil = 0;
            drawGameOverScreen(true, isWin);
        }

        // ---------- Ekran √áizimleri (Ba≈ülangƒ±√ß/Biti≈ü/Level Atlatma) ----------
        
        function drawOverlay(text1, text2, buttonText, onClick) {
            ctx.fillStyle = 'rgba(0, 0, 0, 0.85)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.fillStyle = 'white';
            ctx.textAlign = 'center';
            
            ctx.font = 'bold 36px Inter';
            ctx.fillText(text1, canvas.width / 2, canvas.height / 2 - 50);
            
            ctx.font = '20px Inter';
            ctx.fillText(text2, canvas.width / 2, canvas.height / 2);

            const buttonWidth = 200;
            const buttonHeight = 50;
            const buttonX = canvas.width / 2 - buttonWidth / 2;
            const buttonY = canvas.height / 2 + 50;
            
            ctx.fillStyle = '#e94560'; 
            ctx.fillRect(buttonX, buttonY, buttonWidth, buttonHeight);
            
            ctx.fillStyle = 'white';
            ctx.font = 'bold 22px Inter';
            ctx.fillText(buttonText, canvas.width / 2, buttonY + 33);
            
            return { x: buttonX, y: buttonY, w: buttonWidth, h: buttonHeight, onClick: onClick };
        }
        
        let levelUpTimeout = null;

        function drawLevelUpScreen(visible, newLevel) {
            if (visible) {
                isGameRunning = false;
                
                let text1 = `Seviye ${newLevel.level} Ba≈üarƒ±ldƒ±!`;
                let weaponSymbol = WEAPON_CONFIG[newLevel.projectileType].symbol;
                let text2 = `Yeni Silah: ${weaponSymbol} - ${newLevel.name}`;
                
                if (newLevel.level === 10) {
                    text1 = "BOSS ZAMANI!";
                    text2 = "Ninja Ustasƒ±! Nihai D√º≈üman Seni Bekliyor.";
                }

                currentButton = drawOverlay(text1, text2, "Devam Et", () => {
                    isGameRunning = true;
                    currentButton = null;
                    if (levelUpTimeout) clearTimeout(levelUpTimeout);
                    requestAnimationFrame(gameLoop);
                });
                
                if (levelUpTimeout) clearTimeout(levelUpTimeout);
                levelUpTimeout = setTimeout(() => {
                    if (!isGameRunning && currentButton) {
                        currentButton.onClick();
                    }
                }, 3000);

            } else {
                currentButton = null;
                if (levelUpTimeout) clearTimeout(levelUpTimeout);
            }
        }


        let currentButton = null;

        function drawStartScreen(visible) {
            if (visible) {
                // Ba≈ülangƒ±√ß ekranƒ±nda START_LEVEL_INDEX'e g√∂re seviyeyi ayarla
                levelDisplay.textContent = LEVELS[START_LEVEL_INDEX].level; 
                missedDisplay.textContent = MAX_LIVES;
                
                let startText = LEVELS[START_LEVEL_INDEX].level > 1 
                                ? `Seviye ${LEVELS[START_LEVEL_INDEX].level} (${LEVELS[START_LEVEL_INDEX].name})'den Ba≈üla!`
                                : "Meyveleri dilimlemek i√ßin tƒ±kla!";

                currentButton = drawOverlay("Ninja Hazƒ±r!", startText, "Oyuna Ba≈üla", startGame);
            } else {
                currentButton = null;
            }
        }

        function drawGameOverScreen(visible, isWin = false) {
            if (visible) {
                if (isWin) {
                    currentButton = drawOverlay("TEBRƒ∞KLER!", `Boss'u yendin ve Oyunu bitirdin! Son Skor: ${score}`, "Tekrar Oyna", startGame);
                } else {
                    currentButton = drawOverlay("Oyun Bitti!", `Son Skorun: ${score}`, "Tekrar Oyna", startGame);
                }
            } else {
                currentButton = null;
            }
        }

        // ---------- Olay Dinleyicileri ----------
        
        // Canvas Boyutunu Ayarlama (Responsive)
        function resizeCanvas() {
            const container = document.getElementById('main-container');
            const styleWidth = container.clientWidth;
            
            // 400x600 oranƒ±nƒ± koruyarak canvas boyutunu ayarla
            const targetWidth = Math.min(400, styleWidth - 20); // Maks 400px, container'dan 20px az
            const targetHeight = targetWidth * 1.5; // 600 / 400 = 1.5

            canvas.width = targetWidth;
            canvas.height = targetHeight;
            
            ninjaX = canvas.width / 2; // Ninja pozisyonunu ortala
            
            // Boss can barƒ±nƒ± canvas geni≈üliƒüine e≈üitle
            bossHealthBar.style.width = targetWidth + 'px'; 

            // Oyunun durumuna g√∂re ba≈ülangƒ±√ß ekranƒ±nƒ± yeniden √ßiz
            if (!isGameRunning) {
                drawStartScreen(true);
            }
        }

        window.addEventListener('resize', resizeCanvas);
        
        canvas.addEventListener('mousemove', (event) => {
            if (isGameRunning || currentButton) {
                const rect = canvas.getBoundingClientRect();
                const mouseX = event.clientX - rect.left;
                
                const handSize = 15;
                const minX = handSize + SUPPORT_NINJA_OFFSET; 
                const maxX = canvas.width - handSize;
                
                ninjaX = Math.max(minX, Math.min(maxX, mouseX));
            }
        });
        
        canvas.addEventListener('click', (event) => {
            if (isGameRunning) {
                fireProjectile(ninjaX, canvas.height - 15, false); // false: Oyuncu atƒ±≈üƒ±
            } else if (currentButton) {
                const rect = canvas.getBoundingClientRect();
                const clickX = event.clientX - rect.left;
                const clickY = event.clientY - rect.top;

                if (clickX > currentButton.x && clickX < currentButton.x + currentButton.w &&
                    clickY > currentButton.y && clickY < currentButton.y + currentButton.h) {
                    
                    currentButton.onClick();
                }
            }
        });
        
        window.onload = function() {
            resizeCanvas(); // ƒ∞lk y√ºklemede ve yeniden boyutlandƒ±rmada √ßalƒ±≈üƒ±r
            currentLevelIndex = START_LEVEL_INDEX; 
            drawStartScreen(true);
        };

    </script>
</body>
</html>