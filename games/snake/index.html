<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JOMP - Vertical Ascent</title>
    <!-- Google Fonts: Orbitron for Sci-Fi/Arcade look -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #0a0818;
            /* Daha koyu bir arka plan */
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            /* YÃ¼kseklik her zaman ekran boyu */
            height: 100dvh;
            width: 100vw;
            color: white;
            user-select: none;
            -webkit-user-select: none;
            touch-action: none;
        }

        /* Desktop Container - Oyunu ortada sÄ±nÄ±rlÄ± geniÅŸlikte gÃ¶ster */
        #game-wrapper {
            position: relative;
            width: 100%;
            height: 100%;
            max-width: 600px;
            background-color: #0f0c29;
            /* Desktop'ta estetik kÃ¶ÅŸeler ve gÃ¶lge */
            border-radius: 0;
            overflow: hidden;
        }

        @media (min-width: 601px) {
            #game-wrapper {
                height: calc(100dvh - 40px);
                max-height: 100%;
                border-radius: 24px;
                box-shadow:
                    0 0 0 1px rgba(76, 209, 55, 0.15),
                    0 25px 80px rgba(0, 0, 0, 0.6),
                    0 0 60px rgba(76, 209, 55, 0.1);
            }
        }

        canvas {
            border: none;
            background-color: transparent;
            outline: none;
            /* Canvas'Ä± CSS ile container'a sÄ±ÄŸdÄ±r */
            display: block;
            width: 100%;
            height: 100%;
        }

        #ui-layer {
            position: absolute;
            top: 5%;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            pointer-events: none;
            z-index: 5;
            width: 100%;
        }

        h1 {
            margin: 0;
            font-size: 24px;
            color: #ddd;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        #score-board {
            font-family: 'Orbitron', sans-serif;
            font-size: 64px;
            font-weight: 900;
            color: #fff;
            text-shadow:
                0 0 10px rgba(76, 209, 55, 0.6),
                0 0 20px rgba(76, 209, 55, 0.3),
                3px 3px 0px #302b63;
            letter-spacing: 4px;
        }

        /* Ekran Stilleri */
        .screen-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(15, 12, 41, 0.95);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 0 40px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            gap: 20px;
            z-index: 10;
            min-width: 250px;
            max-width: 90%;
            backdrop-filter: blur(5px);
        }

        #start-screen {
            border: 2px solid #4cd137;
            box-shadow: 0 0 30px rgba(76, 209, 55, 0.2);
        }

        #game-over-screen {
            border: 2px solid #ff4757;
            box-shadow: 0 0 30px rgba(255, 71, 87, 0.3);
        }

        .hidden {
            display: none !important;
        }

        /* Buton Grubu */
        .btn-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 10px;
        }

        button {
            padding: 15px 30px;
            font-family: 'Orbitron', sans-serif;
            font-size: 18px;
            border: none;
            color: #000;
            font-weight: 900;
            cursor: pointer;
            border-radius: 50px;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 2px;
            min-height: 50px;
            touch-action: manipulation;
        }

        /* YeÅŸil Buton (Free Fall) */
        .btn-green {
            background: linear-gradient(135deg, #4cd137, #2ecc71);
            box-shadow: 0 5px 15px rgba(46, 204, 113, 0.4);
        }

        .btn-green:hover {
            transform: scale(1.05) translateY(-2px);
            box-shadow: 0 8px 20px rgba(46, 204, 113, 0.6);
        }

        /* KÄ±rmÄ±zÄ± Buton (Classic/Game Over) */
        .btn-red {
            background: linear-gradient(135deg, #ff6b6b, #ee5253);
            color: white;
            box-shadow: 0 5px 15px rgba(238, 82, 83, 0.4);
        }

        .btn-red:hover {
            transform: scale(1.05) translateY(-2px);
            box-shadow: 0 8px 20px rgba(238, 82, 83, 0.6);
        }

        button:active {
            transform: scale(0.95);
        }

        p {
            color: #ccc;
            margin: 0 auto;
            line-height: 1.6;
            font-size: 14px;
            font-family: 'Segoe UI', sans-serif;
        }

        h2 {
            font-family: 'Orbitron', sans-serif;
            letter-spacing: 4px;
            margin: 0;
            text-shadow: 0 0 10px currentColor;
        }
    </style>
</head>

<body>

    <div id="game-wrapper">
        <div id="ui-layer">
            <div id="score-board">0</div>
        </div>

        <!-- START SCREEN -->
        <div id="start-screen" class="screen-overlay">
            <h2 style="color: #4cd137; font-size: 42px;">JOMP</h2>
            <p>Choose your mode:</p>

            <div class="btn-group">
                <button class="btn-green" onclick="startGame('FREE_FALL')">FREE FALL MODE</button>
                <button class="btn-red" onclick="startGame('CLASSIC')">CLASSIC MODE</button>
            </div>

            <p style="font-size: 12px; opacity: 0.7; margin-top:5px;">
                Free Fall: No death, relax.<br>
                Classic: Don't fall off screen!
            </p>
        </div>

        <!-- GAME OVER SCREEN -->
        <div id="game-over-screen" class="screen-overlay hidden">
            <h2 style="color: #ff4757; font-size: 36px;">GAME OVER</h2>
            <p id="final-score" style="font-size: 24px; color: white; font-family: 'Orbitron', sans-serif;">Score: 0</p>
            <div class="btn-group">
                <button class="btn-red" onclick="returnToMenu()">TRY AGAIN</button>
            </div>
        </div>

        <canvas id="gameCanvas" tabindex="1"></canvas>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreEl = document.getElementById('score-board');
        const startScreen = document.getElementById('start-screen');
        const gameOverScreen = document.getElementById('game-over-screen');
        const finalScoreEl = document.getElementById('final-score');

        // --- Game Constants ---
        const CANVAS_WIDTH = 480;

        let CANVAS_HEIGHT = 800; // BaÅŸlangÄ±Ã§ deÄŸeri
        let FLOOR_LEVEL = CANVAS_HEIGHT - 100;

        // Physics & Gameplay
        const GRAVITY = 0.6;
        const JUMP_FORCE = -14;
        const PLAYER_SIZE = 20;
        const PLATFORM_HEIGHT = 18;
        const BASE_PLATFORM_WIDTH = 120;
        const PLATFORM_GAP_Y = 140;

        // --- Game State ---
        let gameState = 'MENU'; // MENU, PLAYING, GAME_OVER
        let gameMode = 'FREE_FALL'; // 'FREE_FALL' or 'CLASSIC'
        let score = 0;
        let platforms = [];
        let particles = [];
        let bgStars = [];
        let cameraY = 0;

        // --- Player Object ---
        const player = {
            x: CANVAS_WIDTH / 2 - PLAYER_SIZE / 2,
            y: 0,
            vy: 0,
            width: PLAYER_SIZE,
            height: PLAYER_SIZE,
            color: '#4cd137',
            isGrounded: false,
            currentPlatform: null
        };

        // --- Resize Logic ---
        function resize() {
            const wrapper = document.getElementById('game-wrapper');
            const wrapperW = wrapper.clientWidth || 1;
            const wrapperH = wrapper.clientHeight || 1;
            const ratio = wrapperH / wrapperW;

            CANVAS_HEIGHT = CANVAS_WIDTH * ratio;

            if (!Number.isFinite(CANVAS_HEIGHT) || CANVAS_HEIGHT <= 0) {
                CANVAS_HEIGHT = 800;
            }

            canvas.width = CANVAS_WIDTH;
            canvas.height = CANVAS_HEIGHT;

            canvas.style.width = '100%';
            canvas.style.height = '100%';

            FLOOR_LEVEL = CANVAS_HEIGHT - 100;

            if (gameState === 'MENU' && platforms.length > 0) {
                platforms[0].y = FLOOR_LEVEL;
                player.y = platforms[0].y - player.height;
            }
        }

        window.addEventListener('resize', resize);
        resize();


        // --- Classes ---

        // Background Star Class
        class BgStar {
            constructor() {
                this.x = Math.random() * CANVAS_WIDTH;
                this.y = Math.random() * CANVAS_HEIGHT * 2;
                this.size = Math.random() * 2 + 0.5;
                this.speed = Math.random() * 0.2 + 0.05;
                this.alpha = Math.random() * 0.5 + 0.1;
            }

            draw() {
                let relativeY = (this.y - (cameraY * this.speed)) % CANVAS_HEIGHT;
                if (relativeY < 0) relativeY += CANVAS_HEIGHT;

                ctx.fillStyle = `rgba(255, 255, 255, ${this.alpha})`;
                ctx.beginPath();
                ctx.arc(this.x, relativeY, this.size, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        class Platform {
            constructor(y, isMoving = true) {
                this.y = y;
                this.height = PLATFORM_HEIGHT;
                this.isMoving = isMoving;
                this.hue = Math.random() * 360;
                this.color = `hsl(${this.hue}, 70%, 60%)`;

                // Zemin kontrolÃ¼
                if (y >= FLOOR_LEVEL - 5) {
                    this.width = CANVAS_WIDTH;
                    this.x = 0;
                    this.speed = 0;
                    this.color = '#555';
                    this.isFloor = true;
                } else {
                    this.width = Math.random() * (200 - 60) + 60;
                    this.isFloor = false;

                    if (isMoving) {
                        this.x = Math.random() * (CANVAS_WIDTH - this.width);
                        let speedBase = 2 + (Math.abs(y) * 0.0005);
                        this.speed = (Math.random() > 0.5 ? 1 : -1) * (Math.random() * speedBase + 1);
                    } else {
                        this.x = CANVAS_WIDTH / 2 - this.width / 2;
                        this.speed = 0;
                    }
                }
            }

            update() {
                if (this.isMoving) {
                    this.x += this.speed;
                    if (this.x <= 0 || this.x + this.width >= CANVAS_WIDTH) {
                        this.speed *= -1;
                    }
                }
            }

            draw() {
                // Viewport Culling
                if (this.y - cameraY > -100 && this.y - cameraY < CANVAS_HEIGHT + 100) {
                    let drawY = this.y - cameraY;

                    if (this.isFloor) {
                        ctx.fillStyle = '#2d3436';
                        ctx.fillRect(this.x, drawY, this.width, this.height);
                        ctx.fillStyle = '#636e72';
                        ctx.fillRect(this.x, drawY, this.width, 4);
                    } else {
                        ctx.fillStyle = this.color;
                        ctx.fillRect(this.x, drawY, this.width, this.height);

                        ctx.fillStyle = 'rgba(255,255,255, 0.2)';
                        ctx.fillRect(this.x, drawY, this.width, this.height / 2);

                        ctx.fillStyle = 'rgba(0,0,0, 0.3)';
                        ctx.fillRect(this.x, drawY + this.height - 4, this.width, 4);
                    }
                }
            }
        }

        // Particle Class
        class Particle {
            constructor(x, y, color) {
                this.x = x;
                this.y = y;
                this.vx = (Math.random() - 0.5) * 6;
                this.vy = (Math.random() - 0.5) * 6;
                this.alpha = 1;
                this.color = color;
                this.size = Math.random() * 4 + 2;
            }
            update() {
                this.x += this.vx;
                this.y += this.vy;
                this.alpha -= 0.03;
            }
            draw() {
                ctx.globalAlpha = this.alpha;
                ctx.fillStyle = this.color;
                ctx.fillRect(this.x, this.y - cameraY, this.size, this.size);
                ctx.globalAlpha = 1;
            }
        }

        function createExplosion(x, y, color) {
            for (let i = 0; i < 15; i++) {
                particles.push(new Particle(x, y, color));
            }
        }

        // --- Core Functions ---

        function initBackground() {
            bgStars = [];
            let starCount = Math.floor(CANVAS_HEIGHT / 15);
            for (let i = 0; i < starCount; i++) {
                bgStars.push(new BgStar());
            }
        }

        function startGame(mode) {
            resize();

            gameState = 'PLAYING';
            gameMode = mode; // SeÃ§ilen mod
            score = 0;
            cameraY = 0;
            scoreEl.innerText = score;

            platforms = [];
            particles = [];

            // EkranlarÄ± gizle
            startScreen.classList.add('hidden');
            gameOverScreen.classList.add('hidden');

            initBackground();

            window.focus();
            if (canvas.focus) canvas.focus();

            // Zemin
            let basePlat = new Platform(FLOOR_LEVEL, false);
            platforms.push(basePlat);

            // BaÅŸlangÄ±Ã§ PlatformlarÄ±
            for (let i = 1; i < 6; i++) {
                platforms.push(new Platform(FLOOR_LEVEL - (i * PLATFORM_GAP_Y), true));
            }

            // Oyuncu Reset
            player.x = CANVAS_WIDTH / 2 - player.width / 2;
            player.y = basePlat.y - player.height;
            player.vy = 0;
            player.isGrounded = true;
            player.currentPlatform = basePlat;

            gameLoop();
        }

        // ====== LUMUS TOKEN SYSTEM ======
        function sendGameEnd(finalScore) {
            // Parent window'a (Lumus ana uygulamasÄ±na) oyun sonucu gÃ¶nder
            // Token hesaplama: 1000 skor = 1 token
            if (window.parent && window.parent !== window) {
                window.parent.postMessage({
                    type: 'LUMUS_GAME_END',
                    data: { score: finalScore }
                }, '*');
                console.log('ðŸŽ® LUMUS: Game ended with score:', finalScore);
            }
        }

        function triggerGameOver() {
            gameState = 'GAME_OVER';
            finalScoreEl.innerText = `SCORE: ${score}`;
            gameOverScreen.classList.remove('hidden');

            // ðŸ’° Lumus Token: Oyun bittiÄŸinde skoru gÃ¶nder
            sendGameEnd(score);
        }

        function returnToMenu() {
            gameState = 'MENU';
            gameOverScreen.classList.add('hidden');
            startScreen.classList.remove('hidden');

            // Arka planda boÅŸ bir sahne olsun
            platforms = [];
            platforms.push(new Platform(FLOOR_LEVEL, false));
            player.y = FLOOR_LEVEL - player.height;
            cameraY = 0;
            draw();
        }

        function handleInput(e) {
            // Filtreleme
            if (e.type === 'keydown' && e.code !== 'Space') return;
            if (e.target.tagName === 'BUTTON') return;
            if (e.type !== 'keydown' && e.cancelable) e.preventDefault();

            // Sadece PLAYING durumunda zÄ±plama
            if (gameState === 'PLAYING' && player.isGrounded) {
                player.vy = JUMP_FORCE;
                player.isGrounded = false;
                player.currentPlatform = null;
                createExplosion(player.x + player.width / 2, player.y + player.height, '#fff');
            }
        }

        document.addEventListener('keydown', handleInput);
        document.addEventListener('touchstart', handleInput, { passive: false });
        document.addEventListener('mousedown', handleInput);

        canvas.addEventListener('click', () => {
            window.focus();
            if (canvas.focus) canvas.focus();
        });

        function update() {
            if (gameState !== 'PLAYING') return;

            // Physics
            player.vy += GRAVITY;
            player.y += player.vy;

            // --- Floor & Death Logic ---

            // Zemin Ã‡arpÄ±ÅŸmasÄ±
            // FREE_FALL: Zemin her zaman katÄ±dÄ±r.
            // CLASSIC: Zemin katÄ±dÄ±r, AMA kamera yukarÄ± Ã§Ä±ktÄ±ysa zemin aÅŸaÄŸÄ±da (ekran dÄ±ÅŸÄ±) kalÄ±r.
            // Bu durumda oyuncu "off-screen" kontrolÃ¼ne takÄ±lÄ±r ve Ã¶lÃ¼r.
            if (player.y + player.height > FLOOR_LEVEL) {
                if (gameMode === 'FREE_FALL') {
                    // Eski mantÄ±k: Zemine bas ve dur
                    player.y = FLOOR_LEVEL - player.height;
                    player.vy = 0;
                    player.isGrounded = true;
                    player.currentPlatform = platforms[0];
                } else {
                    // CLASSIC Modu:
                    // EÄŸer zemin ekranÄ±n iÃ§indeyse (oyun baÅŸÄ±), tutunabilirsin.
                    // EÄŸer zemin ekranÄ±n dÄ±ÅŸÄ±ndaysa, buradaki kod Ã§alÄ±ÅŸsa bile
                    // birazdan yapÄ±lacak "Game Over Check" oyuncuyu Ã¶ldÃ¼recektir.
                    player.y = FLOOR_LEVEL - player.height;
                    player.vy = 0;
                    player.isGrounded = true;
                    player.currentPlatform = platforms[0];
                }
            }

            // --- Game Over Check (Sadece CLASSIC iÃ§in) ---
            if (gameMode === 'CLASSIC') {
                // EkranÄ±n gÃ¶rÃ¼nen alt kÄ±smÄ±: cameraY + CANVAS_HEIGHT
                // Oyuncu bunun altÄ±na dÃ¼ÅŸerse Ã¶lÃ¼r.
                if (player.y > cameraY + CANVAS_HEIGHT + 50) { // +50px tolerans (tamamen Ã§Ä±ksÄ±n)
                    triggerGameOver();
                    return;
                }
            }

            // Platform Movement
            if (player.isGrounded && player.currentPlatform) {
                let p = player.currentPlatform;
                player.x += p.speed;

                if (player.x < 0) player.x = 0;
                if (player.x + player.width > CANVAS_WIDTH) player.x = CANVAS_WIDTH - player.width;

                if (player.x + player.width < p.x || player.x > p.x + p.width) {
                    player.isGrounded = false;
                    player.currentPlatform = null;
                } else {
                    player.y = p.y - player.height;
                    player.vy = 0;
                }
            }

            // Collision Detection (Platforms)
            if (player.vy > 0 && !player.isGrounded) {
                for (let p of platforms) {
                    if (Math.abs(p.y - player.y) > 100) continue;

                    if (player.y + player.height >= p.y && player.y + player.height <= p.y + p.height + player.vy + 5) {
                        if (player.x + player.width > p.x && player.x < p.x + p.width) {
                            player.y = p.y - player.height;
                            player.vy = 0;
                            player.isGrounded = true;
                            player.currentPlatform = p;
                            createExplosion(player.x + player.width / 2, player.y + player.height, p.color);
                            break;
                        }
                    }
                }
            }

            // --- Camera Logic ---
            // Move Up (Her iki modda da Ã§alÄ±ÅŸÄ±r)
            let targetUp = player.y - CANVAS_HEIGHT * 0.4;
            if (targetUp < cameraY) {
                cameraY += (targetUp - cameraY) * 0.1;
            }

            // Move Down (SADECE FREE FALL MODUNDA)
            if (gameMode === 'FREE_FALL') {
                let targetDown = player.y - CANVAS_HEIGHT * 0.7;
                if (targetDown > cameraY) {
                    cameraY += (targetDown - cameraY) * 0.15;
                }
            }

            if (cameraY > 0) cameraY = 0;

            let currentHeightScore = Math.floor(Math.abs(cameraY / 10));
            score = currentHeightScore;
            scoreEl.innerText = score;

            // Platform Generation
            let highestY = Infinity;
            platforms.forEach(p => { if (p.y < highestY) highestY = p.y; });

            if (highestY > cameraY - 200) {
                platforms.push(new Platform(highestY - PLATFORM_GAP_Y, true));
            }

            platforms.forEach(p => p.update());

            particles.forEach((p, index) => {
                p.update();
                if (p.alpha <= 0) particles.splice(index, 1);
            });
        }

        function draw() {
            let safeHeight = Number.isFinite(CANVAS_HEIGHT) ? CANVAS_HEIGHT : 800;
            let gradient = ctx.createLinearGradient(0, 0, 0, safeHeight);

            gradient.addColorStop(0, '#0f0c29');
            gradient.addColorStop(0.5, '#302b63');
            gradient.addColorStop(1, '#24243e');

            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Stars
            bgStars.forEach(star => star.draw());

            // Grid
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.05)';
            ctx.lineWidth = 1;
            ctx.beginPath();
            let gridY = -(cameraY % 50);
            for (let i = 0; i < CANVAS_HEIGHT / 50 + 2; i++) {
                ctx.moveTo(0, gridY + i * 50);
                ctx.lineTo(CANVAS_WIDTH, gridY + i * 50);
            }
            for (let j = 0; j <= CANVAS_WIDTH; j += 60) {
                ctx.moveTo(j, 0);
                ctx.lineTo(j, CANVAS_HEIGHT);
            }
            ctx.stroke();

            // Entities
            platforms.forEach(p => p.draw());
            particles.forEach(p => p.draw());

            // Player
            ctx.fillStyle = player.color;
            ctx.shadowBlur = 15;
            ctx.shadowColor = player.color;

            let stretch = Math.abs(player.vy) * 0.5;
            if (!player.isGrounded) {
                ctx.fillRect(player.x + stretch / 2, player.y - cameraY, player.width - stretch, player.height + stretch);
            } else {
                ctx.fillRect(player.x, player.y - cameraY, player.width, player.height);
            }
            ctx.shadowBlur = 0;

            ctx.fillStyle = 'black';
            if (!player.isGrounded) {
                ctx.fillRect(player.x + 5 + stretch / 2, player.y - cameraY + 5, 4, 4);
                ctx.fillRect(player.x + 12 - stretch / 2, player.y - cameraY + 5, 4, 4);
            } else {
                ctx.fillRect(player.x + 5, player.y - cameraY + 5, 4, 4);
                ctx.fillRect(player.x + 12, player.y - cameraY + 5, 4, 4);
            }
        }

        function gameLoop() {
            if (gameState === 'PLAYING') {
                update();
                draw();
                requestAnimationFrame(gameLoop);
            }
        }

        resize();

        // Zemin Platformunu Ekle
        platforms.push(new Platform(FLOOR_LEVEL, false));
        player.y = FLOOR_LEVEL - player.height;
        player.currentPlatform = platforms[0];

        initBackground();
        draw();

    </script>
</body>

</html>